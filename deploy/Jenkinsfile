pipeline {
    agent any
    
    environment {
        // Docker é•œåƒä»“åº“é…ç½®
        DOCKER_REGISTRY = 'registry.cn-hangzhou.aliyuncs.com'
        DOCKER_NAMESPACE = 'lingdang'
        IMAGE_TAG = "${BUILD_NUMBER}"
        
        // æœåŠ¡å™¨é…ç½®
        DEPLOY_SERVER = 'ä½ çš„æœåŠ¡å™¨IP'
        DEPLOY_USER = 'root'
        DEPLOY_PATH = '/home/demo'
    }
    
    stages {
        stage('æ‹‰å–ä»£ç ') {
            steps {
                echo 'ğŸ“¥ æ‹‰å–ä»£ç ...'
                git branch: 'master', url: 'https://github.com/ä½ çš„ç”¨æˆ·å/demo.git'
            }
        }
        
        stage('æ„å»ºåç«¯') {
            steps {
                echo 'ğŸ—ï¸  æ„å»ºåç«¯é•œåƒ...'
                dir('backend') {
                    script {
                        docker.build("${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/lingdang-backend:${IMAGE_TAG}")
                        docker.build("${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/lingdang-backend:latest")
                    }
                }
            }
        }
        
        stage('æ„å»ºå‰ç«¯') {
            steps {
                echo 'ğŸ—ï¸  æ„å»ºå‰ç«¯é•œåƒ...'
                dir('frontend') {
                    script {
                        docker.build("${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/lingdang-frontend:${IMAGE_TAG}")
                        docker.build("${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/lingdang-frontend:latest")
                    }
                }
            }
        }
        
        stage('æ¨é€é•œåƒ') {
            steps {
                echo 'ğŸ“¤ æ¨é€é•œåƒåˆ°ä»“åº“...'
                script {
                    docker.withRegistry("https://${DOCKER_REGISTRY}", 'aliyun-docker-registry') {
                        docker.image("${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/lingdang-backend:${IMAGE_TAG}").push()
                        docker.image("${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/lingdang-backend:latest").push()
                        docker.image("${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/lingdang-frontend:${IMAGE_TAG}").push()
                        docker.image("${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/lingdang-frontend:latest").push()
                    }
                }
            }
        }
        
        stage('éƒ¨ç½²åˆ°æœåŠ¡å™¨') {
            steps {
                echo 'ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨...'
                sshagent(['deploy-ssh-key']) {
                    sh """
                        ssh ${DEPLOY_USER}@${DEPLOY_SERVER} '
                            cd ${DEPLOY_PATH}
                            git pull origin master
                            docker-compose down
                            docker-compose pull
                            docker-compose up -d
                            docker-compose ps
                        '
                    """
                }
            }
        }
        
        stage('å¥åº·æ£€æŸ¥') {
            steps {
                echo 'ğŸ” å¥åº·æ£€æŸ¥...'
                script {
                    sh """
                        sleep 10
                        curl -f http://${DEPLOY_SERVER}:8080/api/posts || exit 1
                        curl -f http://${DEPLOY_SERVER} || exit 1
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo 'âœ… éƒ¨ç½²æˆåŠŸï¼'
            // å¯ä»¥æ·»åŠ é€šçŸ¥ï¼šé’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ã€é‚®ä»¶ç­‰
        }
        failure {
            echo 'âŒ éƒ¨ç½²å¤±è´¥ï¼'
            // å¯ä»¥æ·»åŠ å¤±è´¥é€šçŸ¥
        }
    }
}

name: ğŸš€ è‡ªåŠ¨éƒ¨ç½²åˆ°è…¾è®¯äº‘

on:
  push:
    branches:
      - master
      - main

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ” é…ç½® SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸš€ éƒ¨ç½²åˆ°æœåŠ¡å™¨
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_HOST }} 'bash -s' << 'ENDSSH'
            set -e
            
            echo "========================================="
            echo "  å¼€å§‹è‡ªåŠ¨éƒ¨ç½² - é“ƒé“›å¸ˆå…„å¤§æ¨¡å‹åšå®¢"
            echo "========================================="
            
            cd /root/app/LLMBlog
            
            echo ""
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git pull origin master
            
            echo ""
            echo "ğŸ”„ åœæ­¢æ—§æœåŠ¡..."
            docker compose down || true
            
            echo ""
            echo "ğŸ—ï¸ é‡æ–°æ„å»ºé•œåƒ..."
            docker compose build --no-cache
            
            echo ""
            echo "ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡..."
            docker compose up -d
            
            echo ""
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 30
            
            echo ""
            echo "ğŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            docker compose ps
            
            echo ""
            echo "ğŸ” éªŒè¯åç«¯API..."
            curl -f -s http://localhost:8080/api/posts | head -20 || echo "âš ï¸ åç«¯æœªå°±ç»ª"
            
            echo ""
            echo "ğŸ” éªŒè¯å‰ç«¯..."
            curl -f -s http://localhost > /dev/null && echo "âœ… å‰ç«¯æ­£å¸¸" || echo "âš ï¸ å‰ç«¯æœªå°±ç»ª"
            
            echo ""
            echo "========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "========================================="
          ENDSSH
      
      - name: âœ… éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}"
      
      - name: âŒ éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"

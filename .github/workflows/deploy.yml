name: 🚀 自动部署到腾讯云

on:
  push:
    branches:
      - master
      - main

jobs:
  deploy:
    name: 部署到服务器
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 检出代码
        uses: actions/checkout@v4
      
      - name: 🔐 配置 SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: 🚀 部署到服务器
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_HOST }} 'bash -s' << 'ENDSSH'
            set -e
            
            echo "========================================="
            echo "  开始自动部署 - 铃铛师兄大模型博客"
            echo "========================================="
            
            cd /root/app/LLMBlog
            
            echo ""
            echo "📥 拉取最新代码..."
            git pull origin master
            
            # 检查是否是首次部署（Ollama 模型是否存在）
            OLLAMA_INITIALIZED=false
            if docker ps | grep -q lingdang-ollama; then
              if docker exec lingdang-ollama ollama list 2>/dev/null | grep -q "nomic-embed-text"; then
                echo "✅ 检测到 Ollama 模型已存在，跳过初始化"
                OLLAMA_INITIALIZED=true
              fi
            fi
            
            # 首次部署或完全重建
            if [ "$OLLAMA_INITIALIZED" = false ]; then
              echo ""
              echo "🎯 检测到首次部署，执行完整初始化..."
              
              echo ""
              echo "🔄 停止旧服务..."
              docker compose down || true
              
              echo ""
              echo "🏗️ 构建镜像..."
              docker compose build
              
            echo ""
            echo "🚀 启动所有服务（包括 Ollama）..."
            docker compose up -d
            
            echo ""
            echo "📊 检查 Ollama 容器状态..."
            docker ps -a | grep ollama
            
            echo ""
            echo "📝 查看 Ollama 启动日志..."
            docker logs lingdang-ollama 2>&1 | tail -50 || echo "获取日志失败"
            
            echo ""
            echo "⏳ 等待 Ollama 服务启动（最多 120 秒）..."
            for i in {1..24}; do
              if docker exec lingdang-ollama ps aux | grep -q ollama; then
                echo "✅ Ollama 进程已启动（${i}次检查）"
                break
              fi
              echo "⏳ 等待中... ($i/24)"
              sleep 5
            done
            
            echo ""
            echo "🔍 测试 Ollama API..."
            docker exec lingdang-ollama curl -s http://localhost:11434/api/version || echo "⚠️ API 未就绪"
            
            echo ""
            echo "📋 Ollama 容器详细信息..."
            docker inspect lingdang-ollama | grep -A 10 "Health"
            
            echo ""
            echo "⏳ 再等待 30 秒确保服务稳定..."
            sleep 30
              
              echo ""
              echo "📥 初始化 Ollama 模型（首次需要下载 270MB）..."
              chmod +x init-ollama.sh
              ./init-ollama.sh || {
                echo "⚠️ Ollama 初始化失败，尝试手动下载..."
                docker exec lingdang-ollama ollama pull nomic-embed-text
              }
              
              echo ""
              echo "🔄 重启后端应用新配置..."
              docker compose restart backend
              
            else
            echo ""
            echo "🔄 日常更新模式：仅重启后端..."
            
            # 确保所有服务运行中
            docker compose up -d
            
            echo ""
            echo "📊 检查 Ollama 状态..."
            docker ps | grep ollama
            docker logs lingdang-ollama 2>&1 | tail -20
            
            # 重新构建后端（如果代码变化）
            docker compose build backend
            
            # 仅重启后端
            docker compose restart backend
            
            echo "✅ 后端已更新重启"
            fi
            
            echo ""
            echo "⏳ 等待服务稳定..."
            sleep 20
            
            echo ""
            echo "📊 检查服务状态..."
            docker compose ps
            
            echo ""
            echo "🔍 验证 Ollama 模型..."
            docker exec lingdang-ollama ollama list | grep nomic-embed-text && echo "✅ Ollama 模型正常" || echo "⚠️ Ollama 模型缺失"
            
            echo ""
            echo "🔍 验证后端 API..."
            curl -f -s http://localhost:8080/api/health | head -20 || echo "⚠️ 后端未就绪"
            
            echo ""
            echo "🔍 验证前端..."
            curl -f -s http://localhost > /dev/null && echo "✅ 前端正常" || echo "⚠️ 前端未就绪"
            
            echo ""
            echo "========================================="
            echo "✅ 部署完成！"
            echo "========================================="
            echo ""
            echo "📝 部署模式: $([ "$OLLAMA_INITIALIZED" = false ] && echo "首次部署（完整初始化）" || echo "日常更新（仅重启后端）")"
            echo "🔗 访问地址: http://localhost"
            echo "🎨 Studio: http://localhost/studio/login"
            echo "🤖 AI 助手: http://localhost/assistant"
          ENDSSH
      
      - name: ✅ 部署成功通知
        if: success()
        run: |
          echo "🎉 部署成功！"
          echo "访问地址: http://${{ secrets.SERVER_HOST }}"
      
      - name: ❌ 部署失败通知
        if: failure()
        run: |
          echo "❌ 部署失败，请检查日志"

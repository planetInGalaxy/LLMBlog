name: ğŸš€ è‡ªåŠ¨éƒ¨ç½²åˆ°è…¾è®¯äº‘

on:
  push:
    branches:
      - master
      - main

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ” é…ç½® SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸš€ éƒ¨ç½²åˆ°æœåŠ¡å™¨
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_HOST }} "GITHUB_SHA=${{ github.sha }} bash -s" << 'ENDSSH'
            set -e
            
            echo "========================================="
            echo "  å¼€å§‹è‡ªåŠ¨éƒ¨ç½² - é“ƒé“›å¸ˆå…„å¤§æ¨¡å‹åšå®¢"
            echo "========================================="
            
            cd /root/app/LLMBlog
            
            echo ""
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git pull origin master
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡éƒ¨ç½²ï¼ˆOllama æ¨¡å‹æ˜¯å¦å­˜åœ¨ï¼‰
            OLLAMA_INITIALIZED=false
            if docker ps | grep -q lingdang-ollama; then
              if docker exec lingdang-ollama ollama list 2>/dev/null | grep -q "nomic-embed-text"; then
                echo "âœ… æ£€æµ‹åˆ° Ollama æ¨¡å‹å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–"
                OLLAMA_INITIALIZED=true
              fi
            fi
            
            # é¦–æ¬¡éƒ¨ç½²æˆ–å®Œå…¨é‡å»º
            if [ "$OLLAMA_INITIALIZED" = false ]; then
              echo ""
              echo "ğŸ¯ æ£€æµ‹åˆ°é¦–æ¬¡éƒ¨ç½²ï¼Œæ‰§è¡Œå®Œæ•´åˆå§‹åŒ–..."
              
              echo ""
              echo "ğŸ”„ åœæ­¢æ—§æœåŠ¡..."
              docker compose down || true
              
              echo ""
              echo "ğŸ—ï¸ æ„å»ºé•œåƒ..."
              echo "ğŸ“Œ æ„å»ºç‰ˆæœ¬å·: ${GITHUB_SHA}"
              docker compose build --build-arg VITE_APP_VERSION=${GITHUB_SHA}
              
            echo ""
            echo "ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåŒ…æ‹¬ Ollamaï¼‰..."
            docker compose up -d
            
            echo ""
            echo "ğŸ“Š æ£€æŸ¥ Ollama å®¹å™¨çŠ¶æ€..."
            docker ps -a | grep ollama
            
            echo ""
            echo "ğŸ“ æŸ¥çœ‹ Ollama å¯åŠ¨æ—¥å¿—..."
            docker logs lingdang-ollama 2>&1 | tail -50 || echo "è·å–æ—¥å¿—å¤±è´¥"
            
            echo ""
            echo "â³ ç­‰å¾… Ollama æœåŠ¡å¯åŠ¨ï¼ˆæœ€å¤š 120 ç§’ï¼‰..."
            for i in {1..24}; do
              if docker exec lingdang-ollama ps aux | grep -q ollama; then
                echo "âœ… Ollama è¿›ç¨‹å·²å¯åŠ¨ï¼ˆ${i}æ¬¡æ£€æŸ¥ï¼‰"
                break
              fi
              echo "â³ ç­‰å¾…ä¸­... ($i/24)"
              sleep 5
            done
            
            echo ""
            echo "ğŸ” æµ‹è¯• Ollama API..."
            docker exec lingdang-ollama curl -s http://localhost:11434/api/version || echo "âš ï¸ API æœªå°±ç»ª"
            
            echo ""
            echo "ğŸ“‹ Ollama å®¹å™¨è¯¦ç»†ä¿¡æ¯..."
            docker inspect lingdang-ollama | grep -A 10 "Health"
            
            echo ""
            echo "â³ å†ç­‰å¾… 30 ç§’ç¡®ä¿æœåŠ¡ç¨³å®š..."
            sleep 30
              
              echo ""
              echo "ğŸ“¥ åˆå§‹åŒ– Ollama æ¨¡å‹ï¼ˆé¦–æ¬¡éœ€è¦ä¸‹è½½ 270MBï¼‰..."
              chmod +x init-ollama.sh
              ./init-ollama.sh || {
                echo "âš ï¸ Ollama åˆå§‹åŒ–å¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨ä¸‹è½½..."
                docker exec lingdang-ollama ollama pull nomic-embed-text
              }
              
              echo ""
              echo "ğŸ”„ é‡å¯åç«¯åº”ç”¨æ–°é…ç½®..."
              docker compose restart backend
              
            else
            echo ""
            echo "ğŸ”„ æ—¥å¸¸æ›´æ–°æ¨¡å¼ï¼šé‡æ–°æ„å»ºå¹¶é‡å¯..."
            
            echo ""
            echo "ğŸ—ï¸ é‡æ–°æ„å»ºå‰ç«¯å’Œåç«¯..."
            # ä½¿ç”¨ --pull ç¡®ä¿åŸºç¡€é•œåƒæœ€æ–°ï¼Œä½†ä¿ç•™ä¾èµ–ç¼“å­˜åŠ é€Ÿæ„å»º
            echo "ğŸ“Œ æ„å»ºç‰ˆæœ¬å·: ${GITHUB_SHA}"
            docker compose build --pull --build-arg VITE_APP_VERSION=${GITHUB_SHA} frontend backend
            
            echo ""
            echo "ğŸ”„ åœæ­¢æ—§å®¹å™¨å¹¶å¯åŠ¨æ–°å®¹å™¨..."
            docker compose stop frontend backend
            docker compose rm -f frontend backend
            docker compose up -d frontend backend
            
            echo ""
            echo "ğŸ“Š æ£€æŸ¥ Ollama çŠ¶æ€..."
            docker ps | grep ollama
            docker logs lingdang-ollama 2>&1 | tail -20
            
            echo "âœ… å‰ç«¯å’Œåç«¯å·²æ›´æ–°é‡å¯"
            fi
            
            echo ""
            echo "â³ ç­‰å¾…æœåŠ¡ç¨³å®š..."
            sleep 20
            
            echo ""
            echo "ğŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            docker compose ps
            
            echo ""
            echo "ğŸ” éªŒè¯ Ollama æ¨¡å‹..."
            docker exec lingdang-ollama ollama list | grep nomic-embed-text && echo "âœ… Ollama æ¨¡å‹æ­£å¸¸" || echo "âš ï¸ Ollama æ¨¡å‹ç¼ºå¤±"
            
            echo ""
            echo "ğŸ” ç­‰å¾…åç«¯å¯åŠ¨ï¼ˆSpring Boot éœ€è¦æ—¶é—´ï¼‰..."
            for i in {1..30}; do
              if curl -f -s http://localhost:8080/api/health > /dev/null 2>&1; then
                echo "âœ… åç«¯ API å·²å°±ç»ªï¼ˆç­‰å¾… ${i} ç§’ï¼‰"
                curl -s http://localhost:8080/api/health | head -20
                break
              fi
              if [ $i -eq 30 ]; then
                echo "âš ï¸ åç«¯å¯åŠ¨è¶…æ—¶ï¼ŒæŸ¥çœ‹æ—¥å¿—..."
                docker logs lingdang-backend 2>&1 | tail -30
              else
                echo "â³ ç­‰å¾…åç«¯å¯åŠ¨... ($i/30)"
                sleep 2
              fi
            done
            
            echo ""
            echo "ğŸ” éªŒè¯å‰ç«¯..."
            curl -f -s http://localhost > /dev/null && echo "âœ… å‰ç«¯æ­£å¸¸" || echo "âš ï¸ å‰ç«¯æœªå°±ç»ª"
            
            echo ""
            echo "========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "========================================="
            echo ""
            echo "ğŸ“ éƒ¨ç½²æ¨¡å¼: $([ "$OLLAMA_INITIALIZED" = false ] && echo "é¦–æ¬¡éƒ¨ç½²ï¼ˆå®Œæ•´åˆå§‹åŒ–ï¼‰" || echo "æ—¥å¸¸æ›´æ–°ï¼ˆä»…é‡å¯åç«¯ï¼‰")"
            echo "ğŸ”— è®¿é—®åœ°å€: http://localhost"
            echo "ğŸ¨ Studio: http://localhost/studio/login"
            echo "ğŸ¤– AI åŠ©æ‰‹: http://localhost/assistant"
          ENDSSH
      
      - name: âœ… éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}"
      
      - name: âŒ éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
